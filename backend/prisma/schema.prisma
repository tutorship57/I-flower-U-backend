// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init


generator client {
  provider = "prisma-client-js"
}


datasource db {
  provider = "postgresql"
  
}





// User Modules
model User {
  user_id       String       @id @default(cuid())
  user_name          String
  user_email         String    @unique
  user_password      String
  role_id          Int
  role              Role     @relation(fields: [role_id], references: [role_id])
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  shops         Shop[]
  orders        Order[]
  carts         Cart[]
  
}

model Role {
  role_id       Int      @id @default(autoincrement())
  role_name         String    @unique
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  users          User[]
}

// Cart Modules
model Cart {
  cart_id     String  @id @default(cuid())
  user_id     String  @unique
  user        User    @relation(fields: [user_id], references: [user_id])
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  items       CartItem[]
  @@index([user_id])
}
model CartItem {
  cart_item_id String @id @default(cuid())
  cart_id      String
  product_id   String
  quantity     Int     @default(1)
  unit_price   Float   // ราคาตอนหยิบใส่ตะกร้า เผื่อโปรเปลี่ยน
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  cart         Cart    @relation(fields: [cart_id], references: [cart_id], onDelete: Cascade)
  product      Product @relation(fields: [product_id], references: [product_id])
  @@index([cart_id])
}
// Product Modules

// shop section management
model Product {
  product_id      String       @id @default(cuid())
  product_name        String
  product_description String?   
  product_price      Float
  product_stock      Int 
  shop_id       String
  category_id     Int
  category        Category? @relation(fields: [category_id], references: [category_id])
  productColor ProductColor[]
  cartItems        CartItem[] 
  productImage ProductImage[]
  productTagEvent ProductTagEvent[]
  orderItems      OrderItem[]
  shop          Shop    @relation(fields: [shop_id], references: [shop_id])
  setsAsSet   ProductSet[] @relation("setProducts")
  setsAsItem  ProductSet[] @relation("singleItem")
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  @@index([shop_id])
  @@index([category_id])
  @@index([product_name])
}
model ProductSet{
  set_id    String  // FK  Product.product_id (SET)
  item_id   String  // FK  Product.product_id (SINGLE)
  quantity  Int
  productSetProduct Product @relation("setProducts", fields: [set_id], references: [product_id])
  productItemProduct Product @relation("singleItem", fields: [item_id], references: [product_id])
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  @@id([set_id, item_id])
  @@index([set_id])
  @@index([item_id])
}
model ProductImage {
  image_id      String       @id @default(cuid())
  product_id     String
  image_url      String
  file_key     String
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  product       Product   @relation(fields: [product_id], references: [product_id])
  @@index([product_id])
}
model ProductTagEvent {
  tag_id      Int       
  product_id     String
  product         Product   @relation(fields: [product_id], references: [product_id])
  TagEvent       TagEvent   @relation(fields: [tag_id], references: [tag_id])

  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  @@id([tag_id, product_id])
}
model ProductColor {
  product_id     String 
  color_id      Int
  product         Product   @relation(fields: [product_id], references: [product_id])
  color         ColorType   @relation(fields: [color_id], references: [color_id])
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  @@id([product_id, color_id])
}

//admin section product control
model ColorType {
  color_id      Int       @id @default(autoincrement())
  color_name        String    @unique
  // color_hex         String    @unique
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  colors ProductColor[]
}
model Category {
  category_id      Int       @id @default(autoincrement())
  category_name        String    @unique
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  products Product[]
} 
model FlowerType {
  type_id      Int       @id @default(autoincrement())
  type_name        String    @unique
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
}
model TagEvent{
  tag_id      Int       @id @default(autoincrement())
  tag_event_name        String    @unique
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  products ProductTagEvent[]
}


// Promotion Modules

// shop and admin section promotion control
// model Promotion {
//   pro_id      String       @id @default(cuid())
//   pro_name        String
//   pro_description String    
//   pro_discount   Float
//   start_date       DateTime
//   end_date         DateTime
//   product_id     Int
//   created_at    DateTime  @default(now())
//   updated_at    DateTime  @updatedAt
// }



// Order Modules
model Order {
  order_id        String       @id @default(cuid())
  user_id         String
  total_amount    Float
  order_status    OrderStatus  @default(CREATE)
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt  
  user          User     @relation(fields: [user_id], references: [user_id])
  orderItems    OrderItem[]
  payments     Payment[]
  @@index([user_id])
}
enum OrderStatus {
  CREATE
  RESERVE
  WAITING_PAYMENT
  PAID
  EXPIRED
  CANCEL
  REFUND
}
model OrderItem {
  item_id   String       @id @default(cuid())
  order_id        String
  product_id      String
  quantity        Int
  unit_price      Float
  order         Order    @relation(fields: [order_id], references: [order_id], onDelete: Cascade)
  product       Product  @relation(fields: [product_id], references: [product_id])
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt  
  @@index([order_id])
}


// Payment Modules
model Payment {
  payment_id      String       @id @default(cuid())
  order_id        String
  session_id      String  @unique  
  paytype_id      Int? 
  payment_url   String?
  PayType         PayType? @relation(fields: [paytype_id], references: [paytype_id])
  order         Order     @relation(fields: [order_id], references: [order_id])
  payment_status  PaymentStatus @default(PENDING)
  amount          Float
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt  
  @@index([order_id])
} 
enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}
model PayType {
  paytype_id     Int      @id @default(autoincrement())
  paytype_name   String    @unique
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  payments    Payment[]
}
// model CreditCard {
//   card_id     String       @id @default(cuid())
//   card_brand  String
//   card_last4  String
//   card_token String
//   card_exp_month   Int
//   card_exp_year    Int
//   created_at  DateTime  @default(now())
//   updated_at  DateTime  @updatedAt
// }

// Shop Modules
model Shop {
  shop_id      String      @id @default(cuid())
  shop_name    String
  shop_address String
  shop_phone   String
  shop_open    Int      // นาทีจากเที่ยงคืน เช่น 09:00 = 540
  shop_close   Int      // นาทีจากเที่ยงคืน เช่น 21:30 = 1290
  user_id      String
  user         User     @relation(fields: [user_id], references: [user_id])
  products     Product[]
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  @@index([user_id])
}
